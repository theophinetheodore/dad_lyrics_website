{{ define "main" }}

{{/* Breadcrumbs */}}

{{ if not .IsHome }}
{{ partial "breadcrumbs.html" . }}
{{ end }}

<div {{ if .Param "autonumber" }} class="autonumber" {{ end }}>
  <article>
    <header class="single-intro-container">
        {{- /* Title and Summary */}}
        
        <h1 class="single-title">{{ .Title }}</h1>
        {{- with .Param "summary" }}
        <p class="single-summary">{{ . | markdownify }}</p>
        {{- end }}
   
        {{- /* Date, Reading Time and Author */}}
        {{ if or (or (.Param "author") (.Param "authorAvatarPath")) (or .Date (.Param "readTime")) }}
        <div class="single-subsummary">
          {{ with $.Param "authorAvatarPath" }}
            <img src="{{ . }}" alt="Author Avatar" />
          {{ end }}
          <div>
            {{ with .Param "author" }}
            <p class="author"> {{- .}} </p>
            {{ end }}
            <!-- <p class="single-date"> -->
            <!-- {{- with .Date }} -->
            <!--   {{- $dateMachine := . | time.Format "2006-01-02T15:04:05-07:00" }} -->
            <!--   {{- $dateHuman := . | time.Format (default ":date_long" $.Site.Params.singleDateFormat) }} -->
            <!--   <time datetime="{{ $dateMachine }}">{{ $dateHuman }}</time> -->
            <!-- {{- end }} -->
            <!---->
            <!-- {{- if .Param "readTime" }} -->
            <!--   {{ if .Date }}&nbsp; Â· &nbsp;{{ end }} -->
            <!--   {{- .ReadingTime }} min read -->
            <!-- {{- end }} -->
            <!-- </p> -->
          </div>
        </div>
        {{- end}}
        
    </header>
    
    {{- if .Param "showTags" }}
      {{- $taxonomy := "tags" }}
      {{- with .Param $taxonomy }}    
        <div class="single-tags">
            {{- range $index, $tag := . }}
            {{- with $.Site.GetPage (printf "/%s/%s" $taxonomy $tag) -}}
                <span>
                  <a href="{{ .Permalink }}">#{{ .LinkTitle }}</a>
                </span>
            {{- end }}
            {{- end }}
        </div>
      {{- end }}
    {{- end }}
    
    {{- /* Table of Contents */}}
    
    {{- if .Param "toc" }}
      <aside class="toc">
        <p><strong>Table of contents</strong></p>
        {{ .TableOfContents }}
      </aside>
    {{- end }}
    
    {{- /* Page content */}}

    {{ if .Param "scale" }}
    <blockquote style="border: 1px solid; border-radius: 0.5rem;">
      <p>Scale: {{ .Params.scale }}</p>
      <p>Time Signature: {{ .Params.time_signature }}</p>
      <p>Tempo: {{ .Params.tempo }}</p>
    </blockquote>
    {{ end }}

    {{ if .Param "notation"}}
      <button id="tableview">Toggle View</button>

      <div class="table-content" id="table-content">
        <table border='1'>
          <tbody id="song-tbody">
          </tbody>
        </table>
      </div>
    {{ end }}
    
    {{ if .Param "notation"}}
      <div class="single-content hidden" id="single-content">
    {{ else }}
      <div class="single-content" id="single-content">
    {{ end }}
      {{ .Content }}
    </div>

  </article>
  
  {{- /* Comments */}}

  {{- if and .Site.Params.giscus.enable (not .Params.disableComment) }}
    <div class="single-comments">
      {{ partial "comments.html" . }}
    </div>
  {{- end }}

  {{ if .Store.Get "hasMermaid" }}
  {{ $mermaidDarkTheme := default "dark" (or .Params.mermaidDarkTheme .Site.Params.mermaidDarkTheme) }}
  {{ $mermaidTheme := default "default" (or .Params.mermaidTheme .Site.Params.mermaidTheme) }}
  <script defer
    type="module"
    id="mermaid_script"
    data-light-theme="{{ $mermaidTheme }}"
    data-dark-theme="{{ $mermaidDarkTheme }}"
    src='{{ "js/mermaid.js" | relURL }}'>
  </script>
  {{ end }}

  {{/* Next prev controls */}}

  {{ if not (.Param "hidePagination") }}
  {{ partial "pagination-single.html" . }}
  {{ end }}

  {{/* Back to top */}}

  {{ if not (.Param "hideBackToTop") }}
  <div class="back-to-top">
    <a href="#top">
      back to top
    </a>
  </div>
  {{ end }}

  {{ if .Param "notation"}}
    <script defer>
      const text = document.getElementById('single-content').firstElementChild;
      const textArray = text.innerHTML.split("\n");

      let html_str = "";

      for (var i=0; i<textArray.length; i++) {
        if (textArray[i].startsWith("~ Start")) {
          html_str += `<tr><td colspan='2'>${textArray[i]}</td></tr>`
        } else if
          (textArray[i].startsWith("M+F") ||
          textArray[i].startsWith("M") ||
          textArray[i].startsWith("C") ||
          textArray[i].startsWith("F")) {
            html_str += `<tr><td>${textArray[i]}</td>`
            html_str += `<td>${textArray[i + 1]}`
            html_str += `${textArray[i + 2]}</td></tr>`
            i += 2
        } else if (textArray[i].includes("(")) {
            html_str += `<tr><td colspan='2' style='text-align: end'>${textArray[i]}</td></tr>`
        } else {
            html_str += `<tr><td colspan='2'>${textArray[i]}${textArray[i + 1]}</td></tr>`
            i += 1
        }
      }

      document.getElementById('song-tbody').innerHTML = html_str;

      const tableShowButton = document.getElementById('tableview');

      tableShowButton.addEventListener("click", (e) =>{
        document.getElementById('table-content').classList.toggle('hidden');
        document.getElementById('single-content').classList.toggle('hidden');
      })
    </script>
  {{ end }}

</div>

{{ end }}
